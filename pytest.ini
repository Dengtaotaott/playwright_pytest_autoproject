[pytest]
# ==================== 测试发现配置 ====================
# 测试文件匹配模式
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# 测试目录
testpaths = tests

# 忽略的目录（避免扫描虚拟环境、构建产物等）
norecursedirs = .* build dist node_modules venv __pycache__ .git .pytest_cache

# ==================== 命令行选项 ====================
# 注意：--lf / --ff 不建议默认开启，需时手动在命令行加（首轮无失败记录时会提示空）
# -v: 详细输出（verbose），显示每条用例
# --strict-markers: 未声明标记时报错，防止拼写遗漏
# --tb=short: 短回溯，控制台输出更简洁
# --html: 生成 HTML 报告
# --self-contained-html: HTML 报告内嵌资源，便于单文件分发
# --json-report: 生成 JSON 报告（pytest-json-report）
# --json-report-file: JSON 报告输出路径
# --junitxml: 生成 JUnit XML 报告（CI 常用）
# --maxfail: 失败满 5 条即停止，节约时间
# --reruns: 失败用例自动重跑 2 次（pytest-rerunfailures）
# --reruns-delay: 重跑前等待 1 秒
# --durations: 显示最慢的 10 条测试，便于找瓶颈
# --strict-config: 配置错误立即失败，避免静默忽略
# --disable-warnings: 抑制警告输出，保持日志整洁
addopts = 
    -v
    --strict-markers
    --tb=short
    --html=reports/report.html
    --self-contained-html
    --json-report
    --json-report-file=reports/report.json
    --junitxml=reports/junit.xml
    --maxfail=5
    --reruns=2
    --reruns-delay=1
    --durations=10
    --strict-config
    --disable-warnings

# ==================== 超时设置 ====================
# 单个测试用例超时时间（秒）
timeout = 300
timeout_method = thread

# ==================== 标记定义 ====================
markers =
    smoke: 冒烟测试，快速验证核心功能
    regression: 回归测试，全面验证功能
    login: 登录相关测试
    api: API接口测试
    ui: UI界面测试
    slow: 慢速测试，执行时间较长的测试
    critical: 关键功能测试
    integration: 集成测试

# ==================== 日志配置 ====================
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)s] %(name)s:%(lineno)d - %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# 日志文件配置
log_file = logs/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)s] %(name)s:%(lineno)d - %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# ==================== 警告过滤 ====================
# 过滤或提升特定警告级别
filterwarnings =
    error::DeprecationWarning
    ignore::UserWarning
    ignore::PendingDeprecationWarning

# ==================== 其他配置 ====================
# xfail 严格模式：如果标记为 xfail 的测试意外通过，则视为失败
xfail_strict = true

# 最小 pytest 版本要求
minversion = 7.0

# 控制台输出样式（progress/classic/count）
console_output_style = progress

